// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Write your JavaScript code.

(function () {
	function applyTheme(theme) {
		if (theme === 'dark') {
			document.documentElement.classList.add('dark-theme');
		} else {
			document.documentElement.classList.remove('dark-theme');
		}
		var icon = document.getElementById('theme-icon');
		if (icon) icon.textContent = theme === 'dark' ? '🌙' : '☀️';
	}

	document.addEventListener('DOMContentLoaded', function () {
		var stored = localStorage.getItem('site-theme') || 'dark';
		applyTheme(stored);

		var btn = document.getElementById('theme-toggle');
		if (btn) {
			btn.addEventListener('click', function (e) {
				e.preventDefault();
				var isDark = document.documentElement.classList.contains('dark-theme');
				var next = isDark ? 'light' : 'dark';
				localStorage.setItem('site-theme', next);
				applyTheme(next);
			});
		}
	});
	// Visualization Save Logic
	const saveBtn = document.getElementById('btnSaveViz');
	if (saveBtn) {
		saveBtn.addEventListener('click', async function () {
			const nameInput = document.getElementById('vizName');
			const descInput = document.getElementById('vizDesc');
			const statusDiv = document.getElementById('saveStatus');

			// 1. Validation
			if (!nameInput.value.trim()) {
				statusDiv.innerHTML = '<span class="text-danger">Please enter a name.</span>';
				return;
			}

			// 2. Prepare the data (The DTO)
			// Assuming you have an input with id="dbSize" that controls your visualization
			const currentBitSize = document.getElementById('dbSize')?.value || 4;

			const payload = {
				name: nameInput.value,
				bitSize: parseInt(currentBitSize),
				description: descInput.value
			};

			// 3. Send to Server
			statusDiv.innerHTML = '<span class="text-info">Saving...</span>';

			try {
				// Get Anti-Forgery Token for security
				const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

				const response = await fetch('/Visualizations/Save', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token // Important if using MVC controller
					},
					body: JSON.stringify(payload)
				});

				if (response.ok) {
					const result = await response.json();
					statusDiv.innerHTML = `<span class="text-success">Saved! <a href="/Visualizations/Download/${result.id}">Download Report</a></span>`;
					nameInput.value = ''; // Clear input
				} else {
					statusDiv.innerHTML = '<span class="text-danger">Error saving to database.</span>';
				}
			} catch (error) {
				console.error(error);
				statusDiv.innerHTML = '<span class="text-danger">Network error.</span>';
			}
		});
	}
	document.addEventListener('DOMContentLoaded', function () {

		const saveBtn = document.getElementById('btnSaveViz');

		if (!saveBtn) {
			console.error("Save button not found! Check your HTML IDs.");
			return;
		}

		saveBtn.addEventListener('click', async function () {
			console.log("Save button clicked!"); // Check your console for this

			const nameInput = document.getElementById('vizName');
			const descInput = document.getElementById('vizDesc');
			const statusDiv = document.getElementById('saveStatus');

			if (!nameInput || !nameInput.value.trim()) {
				alert("Please enter a name for the visualization.");
				return;
			}

			const payload = {
				name: nameInput.value,
				// Fallback to 4 if the element isn't found
				bitSize: parseInt(document.getElementById('dbSize')?.value || 4),
				description: descInput?.value || ""
			};

			statusDiv.innerHTML = 'Saving...';

			try {
				// Grab the token generated by @Html.AntiForgeryToken()
				const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
				const token = tokenInput ? tokenInput.value : '';

				const response = await fetch('/Visualizations/api/save', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'RequestVerificationToken': token
					},
					body: JSON.stringify(payload)
				});

				console.log("Response status:", response.status);

				if (response.ok) {
					const result = await response.json();
					statusDiv.innerHTML = `<span class="text-success">Saved! Run ID: ${result.id}</span>`;
					nameInput.value = '';
				} else {
					const errorText = await response.text();
					console.error("Server Error:", errorText);
					statusDiv.innerHTML = `<span class="text-danger">Error: ${response.status}</span>`;
				}
			} catch (error) {
				console.error("Network Error:", error);
				statusDiv.innerHTML = '<span class="text-danger">Network error. Check console.</span>';
			}
		});
	});
})();
